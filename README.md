# 여행친구 만들기 앱 만들기

## Backend : supabase

### 초기 Setting

`supabase init`

`supabase start`

`psql -h localhost -p 54322 -U postgres -d postgres`

### Script

#### Users

```
CREATE TABLE PUBLIC."USERS" (
    ID UUID NOT NULL DEFAULT auth.uid(),
    EMAIL TEXT NOT NULL UNIQUE,
    USERNAME TEXT NULL UNIQUE,
    DESCRIPTION TEXT NOT NULL,
    SEX TEXT NOT NULL DEFAULT 'MALE',
    BORN_AT TIMESTAMP WITH TIME ZONE NOT NULL,
    CREATED_AT TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    CONSTRAINT USERS_PKEY PRIMARY KEY (ID),
    CONSTRAINT USERS_FKEY FOREIGN KEY (ID) 
    REFERENCES AUTH.USERS (ID) ON UPDATE CASCADE ON DELETE CASCADE
) TABLESPACE PG_DEFAULT;

ALTER TABLE PUBLIC."USERS" ENABLE ROW LEVEL SECURITY;

CREATE POLICY "PERMIT SELECT TO AUTHENTICATED" 
ON PUBLIC."USERS" FOR SELECT USING (TRUE);

CREATE POLICY "PERMIT INSERT OWN DATA TO AUTHENTICATED" 
ON PUBLIC."USERS" FOR INSERT TO AUTHENTICATED 
WITH CHECK (AUTH.UID() = ID);

CREATE POLICY "PERMIT UPDATE OWN DATA TO AUTHENTICATED"  
ON PUBLIC."USERS" FOR UPDATE TO AUTHENTICATED 
USING (AUTH.UID() = ID);

CREATE POLICY "PERMIT DELETE OWN DATA TO AUTHENTICATED"  
ON PUBLIC."USERS" FOR DELETE TO AUTHENTICATED 
USING (AUTH.UID() = ID);

CREATE OR REPLACE FUNCTION PUBLIC."ON_SIGN_UP"()
RETURNS TRIGGER
LANGUAGE PLPGSQL
SECURITY DEFINER SET SEARCH_PATH = PUBLIC
AS $$
    BEGIN
    INSERT INTO PUBLIC."USERS" (
        ID,
        EMAIL, 
        USERNAME, 
        DESCRIPTION,
        SEX,
        BORN_AT
    )
    VALUES (
        COALESCE(NEW.ID, auth.uid()), 
        NEW.email,
        NEW.RAW_USER_META_DATA->>'username', 
        NEW.RAW_USER_META_DATA->>'description',
        COALESCE(NEW.RAW_USER_META_DATA->>'sex', 'MALE?'),
        (NEW.RAW_USER_META_DATA->>'born_at')::TIMESTAMP WITH TIME ZONE
    );
    RETURN NEW;
    END;
$$;

CREATE TRIGGER ON_AUTH_USER_CREATED
AFTER INSERT ON AUTH.USERS
FOR EACH ROW EXECUTE PROCEDURE PUBLIC."ON_SIGN_UP"();
```